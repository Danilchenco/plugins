<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>KinoJump Debug</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <script>
    if (!window.location) window.location = {};
    if (!('hash' in window.location)) Object.defineProperty(window.location, 'hash', {
      get: () => '#debug'
    });
  </script>

  <script>
    window.Lampa = {
      Platform: {
        sources: [],
        sourceAdd: function (id, instance) {
          this.sources.push({ id, call: instance });  // ‚Üê –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
          console.log(`üì¶ –ò—Å—Ç–æ—á–Ω–∏–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: ${id}`);
        },
        is: () => false
      },
      Settings: {
        listener: { follow: () => {} }
      },
      Storage: {
        field: () => null,
        get: () => '',
        set: () => {},
        cache: () => [],
        listener: { follow: () => {} }
      },
      Arrays: {
        clone: arr => JSON.parse(JSON.stringify(arr))
      },
      Utils: {
        hash: function (str) {
          if (!str) return '';
          let hash = 0;
          for (let i = 0; i < str.length; i++) {
            const chr = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + chr;
            hash |= 0;
          }
          return String(hash);
        }
      },
      Params: { trigger: () => {}, select: () => {} },
      Component: { add: () => {} },
      Template: {
        get: () => $('<div>template</div>'),
        add: () => {}
      },
      Manifest: { plugins: () => {} },
      Listener: { follow: () => {} },
      Timeline: {
        render: () => $('<div class="timeline">[timeline]</div>'),
        details: () => $('<span>[details]</span>'),
        view: () => ({})
      },
      Favorite: { add: () => {} },
      Player: {
        play: (item) => console.log('‚ñ∂Ô∏è play', item),
        playlist: (items) => console.log('üìÉ playlist', items)
      },
      Noty: { show: (msg) => alert(msg) },
      Reguest: function () {
        return {
          clear: () => {},
          timeout: () => {},
          contextmenu: () => {},
          errorDecode: function (a, c) {
            return `–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${c || a}`;
          },
          native: function (url, ok, fail, data, opt) {
            fetch(url, {
              method: opt?.method || (data ? 'POST' : 'GET'),
              headers: opt?.headers || {},
              body: (opt?.method === 'GET' || data === false) ? undefined : data
            }).then(r => {
              if (opt?.dataType === 'text') return r.text();
              if (opt?.dataType === 'json') return r.json();
              return r.text();
            }).then(ok).catch(fail);
          }
        };
      }
    };

    window.component = {
      proxy: () => '',
      reset: () => {},
      proxyLink: (url) => url,
      fixLink: (url) => (url && url.startsWith('http') ? url : 'https://kinojump.com' + url),
      append: (items) => log(['‚úÖ append', items]),
      push: (item) => log(['‚úÖ push', item]),
      loading: (bool) => log(`üîÑ –ó–∞–≥—Ä—É–∑–∫–∞: ${bool}`),
      empty: (msg) => log(`‚ùå –ü—É—Å—Ç–æ: ${msg}`),
      emptyForQuery: (title) => log(`‚ùå –ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è: ${title}`),
      contextmenu: () => {},
      getDefaultQuality: (q, url) => url,
      renameQualityMap: (q) => q
    };
  </script>

  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞ kinojump -->
  <script src="online_mod.js"></script>
</head>
<body>
  <h1>KinoJump Debug</h1>
  <input type="text" id="query" value="–í–ª–∞—Å—Ç–µ–ª–∏–Ω –∫–æ–ª–µ—Ü: –ë—Ä–∞—Ç—Å—Ç–≤–æ –ö–æ–ª—å—Ü–∞" style="width: 300px;">
  <button onclick="start()">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>

  <pre id="log" style="white-space: pre-wrap; margin-top: 20px;"></pre>

  <script>
    function log(msg) {
      const out = document.getElementById('log');
      out.textContent += (typeof msg === 'string' ? msg : JSON.stringify(msg, null, 2)) + '\n\n';
    }

    function start() {
      document.getElementById('log').textContent = '‚ñ∂ –°—Ç–∞—Ä—Ç –æ—Ç–ª–∞–¥–∫–∏...\n\n';

      setTimeout(() => {
        try {
          const query = document.getElementById('query').value.trim();
          const source = Lampa.Platform.sources.find(s => s.id === 'kinojump');

          if (!source || !source.call) {
            log('‚ùå –ò—Å—Ç–æ—á–Ω–∏–∫ kinojump –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
          }

          const plugin = source.call();
          if (typeof plugin.search !== 'function') {
            log('‚ùå –ú–µ—Ç–æ–¥ search –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
          }

          plugin.search({ search: query, movie: { title: query, original_title: query, id: 1 } }, null);
        } catch (e) {
          log('üî• –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ search: ' + e.message);
        }
      }, 200);
    }
  </script>
</body>
</html>
